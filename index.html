<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الهيكل التنظيمي وتحليل بيانات الموظفين</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .upload-area {
            border: 2px dashed #3498db;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            border-radius: 8px;
            cursor: pointer;
            background-color: #f8f9fa;
        }
        .upload-area:hover {
            background-color: #e9ecef;
        }
        .org-chart {
            overflow: auto;
            padding: 20px 0;
            max-height: 70vh;
        }
        .node {
            margin: 10px 0;
            padding: 15px;
            background-color: #3498db;
            color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: relative;
            transition: all 0.3s ease;
        }
        .node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .toggle-icon {
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 20px;
            text-align: center;
        }
        .children {
            padding-right: 30px;
            border-right: 2px dashed #bdc3c7;
            margin-right: 15px;
            margin-top: 10px;
            transition: all 0.3s ease;
        }
        .children.hidden {
            display: none;
        }
        .level-0 {
            background-color: #e74c3c;
            font-size: 18px;
        }
        .level-1 {
            background-color: #3498db;
        }
        .level-2 {
            background-color: #2ecc71;
        }
        .level-3 {
            background-color: #f39c12;
        }
        .level-4 {
            background-color: #9b59b6;
        }
        .level-5 {
            background-color: #1abc9c;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .search-box {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 300px;
            font-size: 16px;
        }
        .btn {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #7f8c8d;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        .node-details {
            margin-top: 10px;
            font-size: 14px;
        }
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .detail-label {
            font-weight: bold;
            color: #ecf0f1;
        }
        .detail-value {
            color: #ffffff;
        }
        .salary-highlight {
            font-size: 16px;
            font-weight: bold;
            color: #fff3cd;
            background-color: #343a40;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 10px;
        }
        .analysis-section {
            margin: 30px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .section-title {
            color: #3498db;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        tr:hover {
            background-color: #e8f4fd;
        }
        .chart-container {
            height: 300px;
            margin: 20px 0;
            position: relative;
        }
        .progress-bar {
            width: 100%;
            background-color: #ecf0f1;
            border-radius: 4px;
            margin: 10px 0;
        }
        .progress {
            height: 20px;
            background-color: #3498db;
            border-radius: 4px;
            text-align: center;
            color: white;
            font-weight: bold;
            line-height: 20px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background-color: #ecf0f1;
            border-radius: 8px 8px 0 0;
        }
        .tab {
            padding: 15px 25px;
            background-color: #ecf0f1;
            border: none;
            cursor: pointer;
            font-weight: bold;
            flex: 1;
            text-align: center;
            transition: all 0.3s ease;
        }
        .tab:hover {
            background-color: #d6eaf8;
        }
        .tab.active {
            background-color: #3498db;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 20px;
            background-color: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .tab-content.active {
            display: block;
        }
        .main-tabs {
            margin-bottom: 30px;
        }
        .main-tab {
            font-size: 18px;
            padding: 15px 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>الهيكل التنظيمي وتحليل بيانات الموظفين</h1>
        
        <div class="upload-area" id="uploadArea">
            <h3>اسحب وأفلت ملف Excel هنا</h3>
            <p>أو</p>
            <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;">
            <button class="btn" onclick="document.getElementById('fileInput').click()">اختر ملف Excel</button>
        </div>
        
        <div class="main-tabs tabs">
            <button class="tab main-tab active" data-tab="org-structure">الهيكل التنظيمي</button>
            <button class="tab main-tab" data-tab="data-analysis">تحليل بيانات الموظفين</button>
        </div>
        
        <div id="org-structure" class="tab-content active">
            <div class="stats" id="orgStats" style="display: none;">
                <div class="stat-item">
                    <div class="stat-number" id="totalEmployees">0</div>
                    <div class="stat-label">إجمالي الموظفين</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalLevels">0</div>
                    <div class="stat-label">عدد المستويات</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="topLevelCount">0</div>
                    <div class="stat-label">الموظفين في المستوى الأعلى</div>
                </div>
            </div>
            
            <div class="controls">
                <input type="text" class="search-box" placeholder="البحث عن موظف..." id="searchInput">
                <div>
                    <button class="btn" id="collapseAllBtn">طي الكل</button>
                    <button class="btn" id="expandAllBtn">توسيع الكل</button>
                </div>
            </div>
            
            <div class="org-chart" id="orgChart">
                <div class="loading">يرجى رفع ملف Excel لعرض الهيكل التنظيمي</div>
            </div>
        </div>
        
        <div id="data-analysis" class="tab-content">
            <div class="tabs">
                <button class="tab active" data-tab="demographics">التحليل الديموغرافي</button>
                <button class="tab" data-tab="departments">تحليل الأقسام</button>
                <button class="tab" data-tab="salaries">تحليل الرواتب</button>
                <button class="tab" data-tab="experience">تحليل الخبرة</button>
            </div>
            
            <div id="demographics" class="tab-content active">
                <div class="analysis-section">
                    <h2 class="section-title">التحليل الديموغرافي</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">إجمالي عدد الموظفين</div>
                            <div class="stat-number" id="demoTotalEmployees">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">عدد الموظفين الذكور</div>
                            <div class="stat-number" id="maleEmployees">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">عدد الموظفات الإناث</div>
                            <div class="stat-number" id="femaleEmployees">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">نسبة الذكور</div>
                            <div class="stat-number" id="malePercentage">0%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">نسبة الإناث</div>
                            <div class="stat-number" id="femalePercentage">0%</div>
                        </div>
                    </div>
                    
                    <h3>التوزيع حسب الجنسية</h3>
                    <table id="nationalityTable">
                        <thead>
                            <tr>
                                <th>الجنسية</th>
                                <th>عدد الموظفين</th>
                                <th>النسبة المئوية</th>
                            </tr>
                        </thead>
                        <tbody id="nationalityTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div id="departments" class="tab-content">
                <div class="analysis-section">
                    <h2 class="section-title">تحليل الأقسام</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">عدد الأقسام</div>
                            <div class="stat-number" id="totalDepartments">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">أكبر قسم</div>
                            <div class="stat-number" id="largestDepartment">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">عدد موظفي أكبر قسم</div>
                            <div class="stat-number" id="largestDepartmentCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">أصغر قسم</div>
                            <div class="stat-number" id="smallestDepartment">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">عدد موظفي أصغر قسم</div>
                            <div class="stat-number" id="smallestDepartmentCount">0</div>
                        </div>
                    </div>
                    
                    <h3>جدول توزيع الموظفين حسب الأقسام</h3>
                    <table id="departmentTable">
                        <thead>
                            <tr>
                                <th>اسم القسم</th>
                                <th>عدد الموظفين</th>
                                <th>النسبة المئوية</th>
                                <th>عدد الذكور</th>
                                <th>عدد الإناث</th>
                            </tr>
                        </thead>
                        <tbody id="departmentTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div id="salaries" class="tab-content">
                <div class="analysis-section">
                    <h2 class="section-title">تحليل الرواتب</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">إجمالي رواتب الموظفين</div>
                            <div class="stat-number" id="totalSalaries">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">أعلى راتب</div>
                            <div class="stat-number" id="highestSalary">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">أدنى راتب</div>
                            <div class="stat-number" id="lowestSalary">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">متوسط الراتب</div>
                            <div class="stat-number" id="averageSalary">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">الراتب الأكثر تكراراً</div>
                            <div class="stat-number" id="modeSalary">0</div>
                        </div>
                    </div>
                    
                    <h3>تحليل الرواتب حسب الأقسام</h3>
                    <table id="salaryDepartmentTable">
                        <thead>
                            <tr>
                                <th>اسم القسم</th>
                                <th>إجمالي الرواتب</th>
                                <th>متوسط الراتب</th>
                                <th>أعلى راتب</th>
                                <th>أدنى راتب</th>
                                <th>عدد الموظفين</th>
                            </tr>
                        </thead>
                        <tbody id="salaryDepartmentTableBody">
                            </tbody>
                    </table>
                    
                    <h3>تحليل الرواتب حسب الجنس</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">متوسط راتب الذكور</div>
                            <div class="stat-number" id="maleAverageSalary">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">متوسط راتب الإناث</div>
                            <div class="stat-number" id="femaleAverageSalary">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">إجمالي رواتب الذكور</div>
                            <div class="stat-number" id="maleTotalSalary">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">إجمالي رواتب الإناث</div>
                            <div class="stat-number" id="femaleTotalSalary">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">الفرق في المتوسط</div>
                            <div class="stat-number" id="salaryDifference">0</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="experience" class="tab-content">
                <div class="analysis-section">
                    <h2 class="section-title">تحليل الخبرة</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">متوسط سنوات الخبرة</div>
                            <div class="stat-number" id="averageExperience">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">أعلى سنوات خبرة</div>
                            <div class="stat-number" id="maxExperience">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">أقل سنوات خبرة</div>
                            <div class="stat-number" id="minExperience">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">عدد الموظفين بأكثر من 10 سنوات خبرة</div>
                            <div class="stat-number" id="experiencedEmployees">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">نسبة الموظفين بأكثر من 10 سنوات خبرة</div>
                            <div class="stat-number" id="experiencedPercentage">0%</div>
                        </div>
                    </div>
                    
                    <h3>تحليل الخبرة حسب الأقسام</h3>
                    <table id="experienceDepartmentTable">
                        <thead>
                            <tr>
                                <th>اسم القسم</th>
                                <th>متوسط سنوات الخبرة</th>
                                <th>أعلى سنوات خبرة</th>
                                <th>أقل سنوات خبرة</th>
                                <th>عدد الموظفين</th>
                            </tr>
                        </thead>
                        <tbody id="experienceDepartmentTableBody">
                            </tbody>
                    </table>
                    
                    <h3>تحليل الخبرة حسب الجنس</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">متوسط خبرة الذكور</div>
                            <div class="stat-number" id="maleAverageExperience">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">متوسط خبرة الإناث</div>
                            <div class="stat-number" id="femaleAverageExperience">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">أعلى خبرة للذكور</div>
                            <div class="stat-number" id="maleMaxExperience">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">أعلى خبرة للإناث</div>
                            <div class="stat-number" id="femaleMaxExperience">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">أقل خبرة للذكور</div>
                            <div class="stat-number" id="maleMinExperience">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // المتغيرات العامة
        let employees = [];
        let orgData = null;
        let isAllExpanded = true;

        // معالجة رفع الملف
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        
        // معالجة السحب والإفلات
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#e9ecef';
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#f8f9fa';
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#f8f9fa';
            
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }
        
        function handleFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // الحصول على أول ورقة في الملف
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // تحويل البيانات إلى JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // معالجة البيانات
                    processExcelData(jsonData);
                    
                    // عرض رسالة نجاح
                    alert('تم تحميل الملف بنجاح!');
                    
                    // تحديث التحليلات
                    updateOrgStructure();
                    updateAnalysis();
                    
                } catch (error) {
                    console.error('خطأ في معالجة الملف:', error);
                    alert('حدث خطأ أثناء معالجة الملف. يرجى التأكد من أن الملف بصيغة Excel وصحيح.');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function processExcelData(data) {
            // البحث عن رؤوس الأعمدة
            let headers = [];
            let startRow = 0;
            
            for (let i = 0; i < data.length; i++) {
                if (Array.isArray(data[i]) && data[i].length > 0) {
                    // البحث عن الصف الذي يحتوي على "الرقم الوظيفي" و"الاسم كاملاً باللغة العربية" وغيرها
                    if (data[i].some(cell => typeof cell === 'string' && cell.includes('الرقم الوظيفي')) &&
                        data[i].some(cell => typeof cell === 'string' && cell.includes('الاسم كاملاً باللغة العربية'))) {
                        headers = data[i].filter(cell => cell !== undefined && cell !== null);
                        startRow = i + 1;
                        break;
                    }
                }
            }
            
            if (headers.length === 0) {
                throw new Error('لم يتم العثور على رؤوس الأعمدة المناسبة في ملف Excel');
            }
            
            // تعيين فهرس كل عمود
            const columnIndices = {};
            headers.forEach((header, index) => {
                if (typeof header === 'string') {
                    if (header.includes('الرقم الوظيفي')) columnIndices.id = index;
                    else if (header.includes('الاسم كاملاً باللغة العربية')) columnIndices.name = index;
                    else if (header.includes('المسمى الوظيفي')) columnIndices.jobTitle = index;
                    else if (header.includes('المدير المباشر')) columnIndices.directManager = index;
                    else if (header.includes('الجنسية')) columnIndices.nationality = index;
                    else if (header.includes('الجنس')) columnIndices.gender = index;
                    else if (header.includes('القسم')) columnIndices.department = index;
                    else if (header.includes('الموقع')) columnIndices.location = index;
                    else if (header.includes('تاريخ الانضمام')) columnIndices.joinDate = index;
                    else if (header.includes('سنوات خبرة العمل')) columnIndices.experience = index;
                    else if (header.includes('الراتب الأساسي')) columnIndices.basicSalary = index;
                    else if (header.includes('بدل سكن')) columnIndices.housingAllowance = index;
                    else if (header.includes('بدل مواصلات')) columnIndices.transportationAllowance = index;
                    else if (header.includes('كامل الراتب')) columnIndices.totalSalary = index;
                }
            });
            
            // التحقق من وجود الأعمدة الأساسية
            if (!columnIndices.name || !columnIndices.jobTitle) {
                throw new Error('لم يتم العثور على الأعمدة الأساسية (الاسم، المسمى الوظيفي) في ملف Excel');
            }
            
            // معالجة بيانات الموظفين
            employees = [];
            for (let i = startRow; i < data.length; i++) {
                const row = data[i];
                if (!Array.isArray(row) || row.length === 0) continue;
                
                // تخطي الصفوف الفارغة أو التي لا تحتوي على اسم الموظف
                if (!row[columnIndices.name] || row[columnIndices.name] === '') continue;
                
                // استخراج سنوات الخبرة كرقم
                let experienceYears = 0;
                if (row[columnIndices.experience]) {
                    const experienceText = row[columnIndices.experience].toString();
                    // استخراج الرقم من النص (مثال: "3 سنة، 6 شهر، 13 يوم")
                    const yearsMatch = experienceText.match(/(\d+)\s*سنة/);
                    const monthsMatch = experienceText.match(/(\d+)\s*شهر/);
                    if (yearsMatch) {
                        experienceYears = parseInt(yearsMatch[1]);
                        if (monthsMatch) {
                            experienceYears += parseInt(monthsMatch[1]) / 12;
                        }
                    }
                }
                
                const employee = {
                    id: row[columnIndices.id] ? row[columnIndices.id].toString() : 'emp_' + Date.now() + '_' + i,
                    name: row[columnIndices.name] ? row[columnIndices.name].toString() : '',
                    jobTitle: row[columnIndices.jobTitle] ? row[columnIndices.jobTitle].toString() : '',
                    directManager: row[columnIndices.directManager] ? row[columnIndices.directManager].toString() : '',
                    nationality: row[columnIndices.nationality] ? row[columnIndices.nationality].toString() : 'غير محدد',
                    gender: row[columnIndices.gender] ? row[columnIndices.gender].toString() : 'غير محدد',
                    department: row[columnIndices.department] ? row[columnIndices.department].toString() : 'غير محدد',
                    location: row[columnIndices.location] ? row[columnIndices.location].toString() : 'غير محدد',
                    joinDate: row[columnIndices.joinDate] ? formatDate(row[columnIndices.joinDate]) : '',
                    experience: row[columnIndices.experience] ? row[columnIndices.experience].toString() : '',
                    experienceYears: experienceYears,
                    basicSalary: row[columnIndices.basicSalary] ? parseFloat(row[columnIndices.basicSalary]) || 0 : 0,
                    housingAllowance: row[columnIndices.housingAllowance] ? parseFloat(row[columnIndices.housingAllowance]) || 0 : 0,
                    transportationAllowance: row[columnIndices.transportationAllowance] ? parseFloat(row[columnIndices.transportationAllowance]) || 0 : 0,
                    totalSalary: row[columnIndices.totalSalary] ? parseFloat(row[columnIndices.totalSalary]) || 0 : 0,
                    children: [],
                    isExpanded: true
                };
                
                // إذا لم يتم تحديد الراتب الإجمالي، نحسبه
                if (employee.totalSalary === 0) {
                    employee.totalSalary = employee.basicSalary + employee.housingAllowance + employee.transportationAllowance;
                }
                
                employees.push(employee);
            }
        }
        
        function formatDate(date) {
            if (typeof date === 'string') {
                return date;
            } else if (date instanceof Date) {
                return date.toISOString().split('T')[0];
            } else {
                // محاولة تحليل التاريخ إذا كان رقمًا (تنسيق Excel)
                try {
                    const excelDate = new Date(Math.round((date - 25569) * 86400 * 1000));
                    return excelDate.toISOString().split('T')[0];
                } catch (e) {
                    return '';
                }
            }
        }
        
        // دالة لتحديث الهيكل التنظيمي
        function updateOrgStructure() {
            if (employees.length === 0) return;
            
            // بناء الهيكل التنظيمي
            buildOrgStructure();
            updateOrgStats();
            renderOrgChart();
            
            // عرض إحصائيات الهيكل
            document.getElementById('orgStats').style.display = 'flex';
        }
        
        // بناء الهيكل التنظيمي من البيانات
        function buildOrgStructure() {
            // إنشاء خريطة للموظفين
            const employeeMap = new Map();
            employees.forEach(emp => {
                // إذا لم يكن هناك ID، ننشئ واحدًا
                if (!emp.id) {
                    emp.id = generateId();
                }
                employeeMap.set(emp.id, {...emp, children: [], isExpanded: true});
            });
            
            // ربط الموظفين بمديريهم
            employees.forEach(emp => {
                if (emp.directManager && emp.directManager.trim() !== '' && emp.directManager !== 'ــــــــــــــــــــــــــــــــــــــــــــــ') {
                    // البحث عن المدير بالاسم
                    const manager = employees.find(m => m.name === emp.directManager);
                    if (manager) {
                        const managerNode = employeeMap.get(manager.id);
                        if (managerNode) {
                            managerNode.children.push(employeeMap.get(emp.id));
                        }
                    }
                }
            });
            
            // العثور على الجذر (الموظفين الذين ليس لديهم مدير أو مديرهم فارغ)
            const rootEmployees = employees.filter(emp => 
                !emp.directManager || 
                emp.directManager.trim() === '' || 
                emp.directManager === 'ــــــــــــــــــــــــــــــــــــــــــــــ'
            );
            
            if (rootEmployees.length > 0) {
                orgData = employeeMap.get(rootEmployees[0].id);
            } else if (employees.length > 0) {
                // إذا لم يتم العثور على جذر، نستخدم أول موظف
                orgData = employeeMap.get(employees[0].id);
            } else {
                // إذا لم يكن هناك موظفين، ننشئ هيكلًا فارغًا
                orgData = {
                    id: generateId(),
                    name: 'الرئيس التنفيذي',
                    jobTitle: 'رئيس تنفيذي',
                    directManager: '',
                    nationality: 'سعودي',
                    gender: 'ذكر',
                    department: 'الادارة التنفيذية',
                    location: 'الادارة التنفيذية',
                    joinDate: new Date().toISOString().split('T')[0],
                    experience: '0 سنة',
                    basicSalary: 0,
                    housingAllowance: 0,
                    transportationAllowance: 0,
                    totalSalary: 0,
                    children: [],
                    isExpanded: true
                };
            }
        }

        // دالة لعرض الهيكل التنظيمي
        function renderOrgChart() {
            const orgChart = document.getElementById('orgChart');
            if (!orgData) {
                orgChart.innerHTML = '<div class="loading">يرجى رفع ملف Excel لعرض الهيكل التنظيمي</div>';
                return;
            }
            orgChart.innerHTML = '';
            orgChart.appendChild(createNodeElement(orgData, 0));
        }

        // دالة لإنشاء عنصر عقدة
        function createNodeElement(node, level) {
            const nodeDiv = document.createElement('div');
            nodeDiv.className = `node level-${level}`;
            nodeDiv.dataset.id = node.id;

            const nodeHeader = document.createElement('div');
            nodeHeader.className = 'node-header';
            
            const titleDiv = document.createElement('div');
            titleDiv.style.display = 'flex';
            titleDiv.style.alignItems = 'center';
            titleDiv.style.gap = '10px';
            
            // إضافة أيقونة الطي/التوسيع إذا كان للعقدة أطفال
            if (node.children && node.children.length > 0) {
                const toggleIcon = document.createElement('span');
                toggleIcon.className = 'toggle-icon';
                toggleIcon.innerHTML = node.isExpanded ? '▼' : '▶';
                toggleIcon.onclick = function(e) {
                    e.stopPropagation();
                    toggleNode(node.id);
                };
                titleDiv.appendChild(toggleIcon);
            }
            
            const titleText = document.createElement('span');
            titleText.innerHTML = `<strong>${node.name}</strong> - ${node.jobTitle}`;
            titleDiv.appendChild(titleText);
            
            nodeHeader.appendChild(titleDiv);
            nodeDiv.appendChild(nodeHeader);
            
            // إضافة تفاصيل الموظف
            const nodeDetails = document.createElement('div');
            nodeDetails.className = 'node-details';
            
            // القسم
            const departmentRow = document.createElement('div');
            departmentRow.className = 'detail-row';
            const departmentLabel = document.createElement('div');
            departmentLabel.className = 'detail-label';
            departmentLabel.textContent = 'القسم:';
            const departmentValue = document.createElement('div');
            departmentValue.className = 'detail-value';
            departmentValue.textContent = node.department;
            departmentRow.appendChild(departmentLabel);
            departmentRow.appendChild(departmentValue);
            nodeDetails.appendChild(departmentRow);
            
            // الموقع
            const locationRow = document.createElement('div');
            locationRow.className = 'detail-row';
            const locationLabel = document.createElement('div');
            locationLabel.className = 'detail-label';
            locationLabel.textContent = 'الموقع:';
            const locationValue = document.createElement('div');
            locationValue.className = 'detail-value';
            locationValue.textContent = node.location;
            locationRow.appendChild(locationLabel);
            locationRow.appendChild(locationValue);
            nodeDetails.appendChild(locationRow);
            
            // الجنسية والجنس
            const nationalityRow = document.createElement('div');
            nationalityRow.className = 'detail-row';
            const nationalityLabel = document.createElement('div');
            nationalityLabel.className = 'detail-label';
            nationalityLabel.textContent = 'الجنسية/الجنس:';
            const nationalityValue = document.createElement('div');
            nationalityValue.className = 'detail-value';
            nationalityValue.textContent = `${node.nationality} / ${node.gender}`;
            nationalityRow.appendChild(nationalityLabel);
            nationalityRow.appendChild(nationalityValue);
            nodeDetails.appendChild(nationalityRow);
            
            // تاريخ الانضمام وسنوات الخبرة
            if (node.joinDate || node.experience) {
                const experienceRow = document.createElement('div');
                experienceRow.className = 'detail-row';
                const experienceLabel = document.createElement('div');
                experienceLabel.className = 'detail-label';
                experienceLabel.textContent = 'الخبرة:';
                const experienceValue = document.createElement('div');
                experienceValue.className = 'detail-value';
                experienceValue.textContent = node.experience ? node.experience : (node.joinDate ? `منذ ${node.joinDate}` : 'غير محدد');
                experienceRow.appendChild(experienceLabel);
                experienceRow.appendChild(experienceValue);
                nodeDetails.appendChild(experienceRow);
            }
            
            // الراتب الإجمالي
            if (node.totalSalary > 0) {
                const salaryDiv = document.createElement('div');
                salaryDiv.className = 'salary-highlight';
                salaryDiv.innerHTML = `الراتب الإجمالي: <strong>${node.totalSalary.toLocaleString()} ريال</strong>`;
                nodeDetails.appendChild(salaryDiv);
            }
            
            nodeDiv.appendChild(nodeDetails);
            
            if (node.children && node.children.length > 0) {
                const childrenDiv = document.createElement('div');
                childrenDiv.className = `children ${node.isExpanded ? '' : 'hidden'}`;
                
                // فرز الأطفال أبجديًا حسب الاسم
                const sortedChildren = [...node.children].sort((a, b) => a.name.localeCompare(b.name, 'ar'));
                
                sortedChildren.forEach(child => {
                    childrenDiv.appendChild(createNodeElement(child, level + 1));
                });
                
                nodeDiv.appendChild(childrenDiv);
            }
            
            return nodeDiv;
        }

        // دالة للطي أو التوسيع
        function toggleNode(nodeId) {
            function findAndToggle(node, targetId) {
                if (node.id === targetId) {
                    node.isExpanded = !node.isExpanded;
                    return true;
                }
                
                if (node.children) {
                    for (let child of node.children) {
                        if (findAndToggle(child, targetId)) {
                            return true;
                        }
                    }
                }
                
                return false;
            }
            
            findAndToggle(orgData, nodeId);
            renderOrgChart();
        }

        // دالة للطي الكل
        function collapseAll() {
            function collapseNode(node) {
                node.isExpanded = false;
                if (node.children) {
                    node.children.forEach(child => collapseNode(child));
                }
            }
            
            if (orgData) {
                collapseNode(orgData);
                isAllExpanded = false;
                renderOrgChart();
            }
        }

        // دالة للتوسيع الكل
        function expandAll() {
            function expandNode(node) {
                node.isExpanded = true;
                if (node.children) {
                    node.children.forEach(child => expandNode(child));
                }
            }
            
            if (orgData) {
                expandNode(orgData);
                isAllExpanded = true;
                renderOrgChart();
            }
        }

        // دالة لتحديث إحصائيات الهيكل
        function updateOrgStats() {
            if (!orgData) return;
            
            // حساب إجمالي الموظفين
            function countEmployees(node) {
                let count = 1; // العد يشمل العقدة الحالية
                if (node.children) {
                    node.children.forEach(child => {
                        count += countEmployees(child);
                    });
                }
                return count;
            }
            
            // حساب أقصى عمق
            function getMaxDepth(node, currentDepth = 0) {
                let maxDepth = currentDepth;
                if (node.children) {
                    node.children.forEach(child => {
                        const childDepth = getMaxDepth(child, currentDepth + 1);
                        if (childDepth > maxDepth) {
                            maxDepth = childDepth;
                        }
                    });
                }
                return maxDepth;
            }
            
            // حساب عدد الموظفين في المستوى الأعلى (الأطفال المباشرين للجذر)
            const topLevelCount = orgData.children ? orgData.children.length : 0;
            
            // تحديث الإحصائيات
            document.getElementById('totalEmployees').textContent = countEmployees(orgData);
            document.getElementById('demoTotalEmployees').textContent = countEmployees(orgData);
            document.getElementById('totalLevels').textContent = getMaxDepth(orgData) + 1; // +1 لأننا نبدأ من 0
            document.getElementById('topLevelCount').textContent = topLevelCount;
        }

        // دالة للبحث في الهيكل التنظيمي
        function searchOrgChart() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (!searchTerm) {
                renderOrgChart();
                return;
            }
            
            function searchNode(node, term) {
                if (node.name.toLowerCase().includes(term) || 
                    node.jobTitle.toLowerCase().includes(term) ||
                    node.department.toLowerCase().includes(term) ||
                    node.location.toLowerCase().includes(term)) {
                    return true;
                }
                
                if (node.children) {
                    for (let child of node.children) {
                        if (searchNode(child, term)) {
                            return true;
                        }
                    }
                }
                
                return false;
            }
            
            function filterNode(node, term) {
                if (searchNode(node, term)) {
                    const filteredNode = {...node};
                    if (filteredNode.children) {
                        filteredNode.children = filteredNode.children
                            .map(child => filterNode(child, term))
                            .filter(child => child !== null);
                    }
                    return filteredNode;
                }
                return null;
            }
            
            const filteredData = filterNode(orgData, searchTerm);
            if (filteredData) {
                const orgChart = document.getElementById('orgChart');
                orgChart.innerHTML = '';
                orgChart.appendChild(createNodeElement(filteredData, 0));
            } else {
                document.getElementById('orgChart').innerHTML = '<div style="text-align: center; padding: 20px;">لا توجد نتائج مطابقة للبحث</div>';
            }
        }
        
        // دالة لتحديث التحليلات
        function updateAnalysis() {
            if (employees.length === 0) return;
            
            // التحليل الديموغرافي
            updateDemographicsAnalysis();
            
            // تحليل الأقسام
            updateDepartmentsAnalysis();
            
            // تحليل الرواتب
            updateSalariesAnalysis();
            
            // تحليل الخبرة
            updateExperienceAnalysis();
        }
        
        // التحليل الديموغرافي
        function updateDemographicsAnalysis() {
            // عدد الموظفين حسب الجنس
            const maleCount = employees.filter(emp => emp.gender === 'ذكر').length;
            const femaleCount = employees.filter(emp => emp.gender === 'أنثى').length;
            const totalCount = employees.length;
            
            document.getElementById('maleEmployees').textContent = maleCount;
            document.getElementById('femaleEmployees').textContent = femaleCount;
            document.getElementById('malePercentage').textContent = ((maleCount / totalCount) * 100).toFixed(1) + '%';
            document.getElementById('femalePercentage').textContent = ((femaleCount / totalCount) * 100).toFixed(1) + '%';
            
            // التوزيع حسب الجنسية
            const nationalityMap = {};
            employees.forEach(emp => {
                nationalityMap[emp.nationality] = (nationalityMap[emp.nationality] || 0) + 1;
            });
            
            // فرز الجنسيات حسب العدد
            const sortedNationalities = Object.entries(nationalityMap).sort((a, b) => b[1] - a[1]);
            
            // تحديث جدول الجنسية
            const nationalityTableBody = document.getElementById('nationalityTableBody');
            nationalityTableBody.innerHTML = '';
            
            sortedNationalities.forEach(([nationality, count]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${nationality}</td>
                    <td>${count}</td>
                    <td>${((count / totalCount) * 100).toFixed(1)}%</td>
                `;
                nationalityTableBody.appendChild(row);
            });
        }
        
        // تحليل الأقسام
        function updateDepartmentsAnalysis() {
            // تجميع الموظفين حسب القسم
            const departmentMap = {};
            employees.forEach(emp => {
                if (!departmentMap[emp.department]) {
                    departmentMap[emp.department] = {
                        count: 0,
                        maleCount: 0,
                        femaleCount: 0,
                        employees: []
                    };
                }
                departmentMap[emp.department].count++;
                departmentMap[emp.department].employees.push(emp);
                if (emp.gender === 'ذكر') {
                    departmentMap[emp.department].maleCount++;
                } else if (emp.gender === 'أنثى') {
                    departmentMap[emp.department].femaleCount++;
                }
            });
            
            // عدد الأقسام
            const departmentCount = Object.keys(departmentMap).length;
            document.getElementById('totalDepartments').textContent = departmentCount;
            
            // أكبر وأصغر قسم
            let largestDepartment = '';
            let smallestDepartment = '';
            let largestCount = 0;
            let smallestCount = Infinity;
            
            for (const [dept, data] of Object.entries(departmentMap)) {
                if (data.count > largestCount) {
                    largestCount = data.count;
                    largestDepartment = dept;
                }
                if (data.count < smallestCount) {
                    smallestCount = data.count;
                    smallestDepartment = dept;
                }
            }
            
            document.getElementById('largestDepartment').textContent = largestDepartment;
            document.getElementById('largestDepartmentCount').textContent = largestCount;
            document.getElementById('smallestDepartment').textContent = smallestDepartment;
            document.getElementById('smallestDepartmentCount').textContent = smallestCount;
            
            // فرز الأقسام حسب العدد
            const sortedDepartments = Object.entries(departmentMap).sort((a, b) => b[1].count - a[1].count);
            
            // تحديث جدول الأقسام
            const departmentTableBody = document.getElementById('departmentTableBody');
            departmentTableBody.innerHTML = '';
            
            sortedDepartments.forEach(([department, data]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${department}</td>
                    <td>${data.count}</td>
                    <td>${((data.count / employees.length) * 100).toFixed(1)}%</td>
                    <td>${data.maleCount}</td>
                    <td>${data.femaleCount}</td>
                `;
                departmentTableBody.appendChild(row);
            });
        }
        
        // تحليل الرواتب
        function updateSalariesAnalysis() {
            // الإحصائيات الأساسية للرواتب
            const totalSalaries = employees.reduce((sum, emp) => sum + emp.totalSalary, 0);
            const highestSalary = Math.max(...employees.map(emp => emp.totalSalary));
            const lowestSalary = Math.min(...employees.map(emp => emp.totalSalary));
            const averageSalary = totalSalaries / employees.length;
            
            // حساب الراتب الأكثر تكراراً (Mode)
            const salaryFrequency = {};
            employees.forEach(emp => {
                salaryFrequency[emp.totalSalary] = (salaryFrequency[emp.totalSalary] || 0) + 1;
            });
            const modeSalary = Object.entries(salaryFrequency).reduce((a, b) => a[1] > b[1] ? a : b)[0];
            
            document.getElementById('totalSalaries').textContent = totalSalaries.toLocaleString() + ' ريال';
            document.getElementById('highestSalary').textContent = highestSalary.toLocaleString() + ' ريال';
            document.getElementById('lowestSalary').textContent = lowestSalary.toLocaleString() + ' ريال';
            document.getElementById('averageSalary').textContent = Math.round(averageSalary).toLocaleString() + ' ريال';
            document.getElementById('modeSalary').textContent = parseFloat(modeSalary).toLocaleString() + ' ريال';
            
            // تحليل الرواتب حسب الأقسام
            const departmentMap = {};
            employees.forEach(emp => {
                if (!departmentMap[emp.department]) {
                    departmentMap[emp.department] = {
                        totalSalary: 0,
                        count: 0,
                        salaries: []
                    };
                }
                departmentMap[emp.department].totalSalary += emp.totalSalary;
                departmentMap[emp.department].count++;
                departmentMap[emp.department].salaries.push(emp.totalSalary);
            });
            
            // فرز الأقسام حسب إجمالي الرواتب
            const sortedDepartments = Object.entries(departmentMap).sort((a, b) => b[1].totalSalary - a[1].totalSalary);
            
            // تحديث جدول الرواتب حسب الأقسام
            const salaryDepartmentTableBody = document.getElementById('salaryDepartmentTableBody');
            salaryDepartmentTableBody.innerHTML = '';
            
            sortedDepartments.forEach(([department, data]) => {
                const avgSalary = data.totalSalary / data.count;
                const maxSalary = Math.max(...data.salaries);
                const minSalary = Math.min(...data.salaries);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${department}</td>
                    <td>${data.totalSalary.toLocaleString()} ريال</td>
                    <td>${Math.round(avgSalary).toLocaleString()} ريال</td>
                    <td>${maxSalary.toLocaleString()} ريال</td>
                    <td>${minSalary.toLocaleString()} ريال</td>
                    <td>${data.count}</td>
                `;
                salaryDepartmentTableBody.appendChild(row);
            });
            
            // تحليل الرواتب حسب الجنس
            const maleEmployees = employees.filter(emp => emp.gender === 'ذكر');
            const femaleEmployees = employees.filter(emp => emp.gender === 'أنثى');
            
            const maleTotalSalary = maleEmployees.reduce((sum, emp) => sum + emp.totalSalary, 0);
            const femaleTotalSalary = femaleEmployees.reduce((sum, emp) => sum + emp.totalSalary, 0);
            const maleAverageSalary = maleEmployees.length > 0 ? maleTotalSalary / maleEmployees.length : 0;
            const femaleAverageSalary = femaleEmployees.length > 0 ? femaleTotalSalary / femaleEmployees.length : 0;
            const salaryDifference = Math.abs(maleAverageSalary - femaleAverageSalary);
            
            document.getElementById('maleAverageSalary').textContent = Math.round(maleAverageSalary).toLocaleString() + ' ريال';
            document.getElementById('femaleAverageSalary').textContent = Math.round(femaleAverageSalary).toLocaleString() + ' ريال';
            document.getElementById('maleTotalSalary').textContent = maleTotalSalary.toLocaleString() + ' ريال';
            document.getElementById('femaleTotalSalary').textContent = femaleTotalSalary.toLocaleString() + ' ريال';
            document.getElementById('salaryDifference').textContent = Math.round(salaryDifference).toLocaleString() + ' ريال';
        }
        
        // تحليل الخبرة
        function updateExperienceAnalysis() {
            // الإحصائيات الأساسية للخبرة
            const totalExperience = employees.reduce((sum, emp) => sum + emp.experienceYears, 0);
            const averageExperience = totalExperience / employees.length;
            const maxExperience = Math.max(...employees.map(emp => emp.experienceYears));
            const minExperience = Math.min(...employees.map(emp => emp.experienceYears));
            
            // عدد الموظفين بأكثر من 10 سنوات خبرة
            const experiencedEmployees = employees.filter(emp => emp.experienceYears > 10).length;
            const experiencedPercentage = (experiencedEmployees / employees.length) * 100;
            
            document.getElementById('averageExperience').textContent = averageExperience.toFixed(1) + ' سنة';
            document.getElementById('maxExperience').textContent = maxExperience.toFixed(1) + ' سنة';
            document.getElementById('minExperience').textContent = minExperience.toFixed(1) + ' سنة';
            document.getElementById('experiencedEmployees').textContent = experiencedEmployees;
            document.getElementById('experiencedPercentage').textContent = experiencedPercentage.toFixed(1) + '%';
            
            // تحليل الخبرة حسب الأقسام
            const departmentMap = {};
            employees.forEach(emp => {
                if (!departmentMap[emp.department]) {
                    departmentMap[emp.department] = {
                        totalExperience: 0,
                        count: 0,
                        experiences: []
                    };
                }
                departmentMap[emp.department].totalExperience += emp.experienceYears;
                departmentMap[emp.department].count++;
                departmentMap[emp.department].experiences.push(emp.experienceYears);
            });
            
            // فرز الأقسام حسب متوسط الخبرة
            const sortedDepartments = Object.entries(departmentMap).sort((a, b) => {
                const avgA = a[1].totalExperience / a[1].count;
                const avgB = b[1].totalExperience / b[1].count;
                return avgB - avgA;
            });
            
            // تحديث جدول الخبرة حسب الأقسام
            const experienceDepartmentTableBody = document.getElementById('experienceDepartmentTableBody');
            experienceDepartmentTableBody.innerHTML = '';
            
            sortedDepartments.forEach(([department, data]) => {
                const avgExperience = data.totalExperience / data.count;
                const maxExperience = Math.max(...data.experiences);
                const minExperience = Math.min(...data.experiences);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${department}</td>
                    <td>${avgExperience.toFixed(1)} سنة</td>
                    <td>${maxExperience.toFixed(1)} سنة</td>
                    <td>${minExperience.toFixed(1)} سنة</td>
                    <td>${data.count}</td>
                `;
                experienceDepartmentTableBody.appendChild(row);
            });
            
            // تحليل الخبرة حسب الجنس
            const maleEmployees = employees.filter(emp => emp.gender === 'ذكر');
            const femaleEmployees = employees.filter(emp => emp.gender === 'أنثى');
            
            const maleAverageExperience = maleEmployees.length > 0 ? 
                maleEmployees.reduce((sum, emp) => sum + emp.experienceYears, 0) / maleEmployees.length : 0;
            const femaleAverageExperience = femaleEmployees.length > 0 ? 
                femaleEmployees.reduce((sum, emp) => sum + emp.experienceYears, 0) / femaleEmployees.length : 0;
            const maleMaxExperience = maleEmployees.length > 0 ? 
                Math.max(...maleEmployees.map(emp => emp.experienceYears)) : 0;
            const femaleMaxExperience = femaleEmployees.length > 0 ? 
                Math.max(...femaleEmployees.map(emp => emp.experienceYears)) : 0;
            const maleMinExperience = maleEmployees.length > 0 ? 
                Math.min(...maleEmployees.map(emp => emp.experienceYears)) : 0;
            
            document.getElementById('maleAverageExperience').textContent = maleAverageExperience.toFixed(1) + ' سنة';
            document.getElementById('femaleAverageExperience').textContent = femaleAverageExperience.toFixed(1) + ' سنة';
            document.getElementById('maleMaxExperience').textContent = maleMaxExperience.toFixed(1) + ' سنة';
            document.getElementById('femaleMaxExperience').textContent = femaleMaxExperience.toFixed(1) + ' سنة';
            document.getElementById('maleMinExperience').textContent = maleMinExperience.toFixed(1) + ' سنة';
        }
        
        // دالة لتوليد معرف فريد
        function generateId() {
            return Date.now().toString() + Math.floor(Math.random() * 1000).toString();
        }

        // ربط أزرار الطي والتوسيع
        document.getElementById('collapseAllBtn').onclick = collapseAll;
        document.getElementById('expandAllBtn').onclick = expandAll;

        // البحث عند الكتابة
        document.getElementById('searchInput').addEventListener('input', searchOrgChart);

        // تبديل بين التبويبات الرئيسية
        document.querySelectorAll('.main-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById(this.getAttribute('data-tab')).classList.add('active');
            });
        });

        // تبديل بين التبويبات الفرعية في تحليل البيانات
        document.querySelectorAll('.tab:not(.main-tab)').forEach(tab => {
            tab.addEventListener('click', function() {
                const parentTabContent = this.closest('.tab-content');
                parentTabContent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                parentTabContent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                parentTabContent.querySelector(`#${this.getAttribute('data-tab')}`).classList.add('active');
            });
        });
    </script>
</body>
</html>